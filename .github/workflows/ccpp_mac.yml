name: C/C++ CI macos

on:
  push:
    branches:
      - CI

jobs:
  build:

    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v2
      with:
        ref: 'CI'
    - name: change date in version
      run: |
        sed "s/+UNKNOWN/_$(date '+%F')/" version.inc > version.date.inc
        mv version.date.inc version.inc
    - name: get deps
      run: curl -L -o deps_linux.zip https://github.com/supermerill/SuperSlicer_deps/releases/latest/download/deps_mac.zip
    - name: unzip deps
      run: unzip deps_mac
    - name: mkdir build
      run: mkdir build
    - name: cmake
      working-directory: ./build
      run: cmake .. -DCMAKE_PREFIX_PATH="$PWD/../destdir/usr/local" -DCMAKE_OSX_DEPLOYMENT_TARGET="10.13" -DSLIC3R_STATIC=1
    - name: make slic3r
      working-directory: ./build
      run: make slic3r
    - name: update Info.plist
      working-directory: ./build/src
      run: sed "s/+UNKNOWN/_$(date '+%F')/" Info.plist >Info.date.plist
    - name: create directory and copy into it
      working-directory: ./build
      run: |
        mkdir SuperSlicer
        mkdir SuperSlicer/SuperSlicer.app
        mkdir SuperSlicer/SuperSlicer.app/Contents
        mkdir SuperSlicer/SuperSlicer.app/Contents/_CodeSignature
        mkdir SuperSlicer/SuperSlicer.app/Contents/Frameworks
        mkdir SuperSlicer/SuperSlicer.app/Contents/MacOS
    - name: copy resources
      working-directory: ./build
      run: |
        cp -Rf ../resources SuperSlicer/SuperSlicer.app/Contents/resources
        cp SuperSlicer/SuperSlicer.app/Contents/resources/icons/slic3r.icns SuperSlicer/SuperSlicer.app/Contents/resources/Slic3r.icns
        cp src/Info.date.plist SuperSlicer/SuperSlicer.app/Contents/Info.plist
        echo -n -e 'APPL????\x0a' > PkgInfo
        cp PkgInfo SuperSlicer/SuperSlicer.app/Contents/PkgInfo
#        echo -n -e '\xff\xfeAPPL\x3f\x00\x3f\x00\x3f\x00\x3f\x00\x0a\x00' > PkgInfo
    - name: copy bin and do not let it lower case
      working-directory: ./build
      run: |
        cp -f src/superslicer SuperSlicer/SuperSlicer.app/Contents/MacOS/SuperSlicer
        chmod u+x SuperSlicer/SuperSlicer.app/Contents/MacOS/SuperSlicer
        tar -cvf SuperSlicer.tar SuperSlicer
    - name: create dmg
      working-directory: ./build
      run: |
        hdiutil create -ov -fs HFS+ -volname "SuperSlicer" -srcfolder "SuperSlicer" temp.dmg
        hdiutil convert temp.dmg -format UDZO -o SuperSlicer.dmg
#    - name: signing resources (creating CodeResources inside _CodeSignature)
#      working-directory: .
#      run: codesign -s <identity> resources
# maybe i should just try to do that on a separate pc and copy the file here, more secure as a signing process.
    - name: Upload artifact
      uses: actions/upload-artifact@v1.0.0
      with:
        name: nightly_macos.tar
        path: build/SuperSlicer.tar
    - name: Upload artifact
      uses: actions/upload-artifact@v1.0.0
      with:
        name: nightly_macos.dmg
        path: build/SuperSlicer.dmg
# build again, but the debug one this time
    - name: cmake
      working-directory: ./build
      run: cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_PREFIX_PATH="$PWD/../destdir/usr/local" -DCMAKE_OSX_DEPLOYMENT_TARGET="10.13" -DSLIC3R_STATIC=1
    - name: make slic3r
      working-directory: ./build
      run: make slic3r
    - name: copy bin and do not let it lower case
      working-directory: ./build
      run: |
        cp -f src/superslicer SuperSlicer/SuperSlicer.app/Contents/MacOS/SuperSlicer
        chmod u+x SuperSlicer/SuperSlicer.app/Contents/MacOS/SuperSlicer
        tar -cvf SuperSlicer.tar SuperSlicer
    - name: create dmg
      working-directory: ./build
      run: |
        rm SuperSlicer.dmg
        hdiutil create -ov -fs HFS+ -volname "SuperSlicer" -srcfolder "SuperSlicer" temp.dmg
        hdiutil convert temp.dmg -format UDZO -o SuperSlicer.dmg
    - name: Upload artifact
      uses: actions/upload-artifact@v1.0.0
      with:
        name: nightly_macos_DEBUG.dmg
        path: build/SuperSlicer.dmg
